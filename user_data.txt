#!/bin/bash
# Обновление пакетов
apt-get update

apt-get install -y openssh-server

# Создание директории для SSH ключей
mkdir -p /home/ubuntu/.ssh
chmod 700 /home/ubuntu/.ssh

# Добавление вашего публичного ключа
echo "${SSH_PUBLIC_KEY}" >> /home/ubuntu/.ssh/authorized_keys
chmod 600 /home/ubuntu/.ssh/authorized_keys

# Установка необходимых пакетов
apt-get install -y apt-transport-https ca-certificates curl software-properties-common

# Установка Docker
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add -
add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
apt-get update
apt-get install -y docker-ce

# Запуск Docker
systemctl start docker
systemctl enable docker

# Запуск контейнера с PostgreSQL
docker run -d
  --name postgres-db
  -e POSTGRES_USER=myuser
  -e POSTGRES_PASSWORD=mypassword
  -e POSTGRES_DB=mydatabase
  -p 5432:5432
  postgres:latest

# Запуск контейнера с Spring Boot приложением
docker run -d
  --name vvo15/my-image-server1
  -p 8080:8080
  --link postgres-db:postgres
  -e SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/mydatabase
  -e SPRING_DATASOURCE_USERNAME=example
  -e SPRING_DATASOURCE_PASSWORD=example
  my-spring-boot-app:latest # Замените на имя вашего Docker образа
